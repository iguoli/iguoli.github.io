---
title: Jenkins
date: 2022-05-31
modify_date: 2022-05-31
tags: CICD Jenkins
key: Jenkins-2022-05-31
---

## [容器中运行](https://github.com/jenkinsci/docker)

### [Master](https://hub.docker.com/r/jenkins/jenkins)

如果使用 nginx 作为反向代理，并设置 context path 为 `/jenkins`，需要向容器传入环境变量 `--env JENKINS_OPTS="--prefix=/jenkins"`

在主机上创建 `/var/jenkins_home` 目录并修改权限，使得 container 中的 jenkins user 可以访问

```bash
mkdir /var/jenkins_home

chown -R 1000:1000 /var/jenkins_home
```

- 无证书访问，启动端口为 8080

```bash
docker run -it --name jenkins-master -v /var/jenkins_home:/var/jenkins_home -p 8080:8080 -p 50000:50000 --restart=on-failure -e JENKINS_OPTS="--prefix=/jenkins" jenkins/jenkins:lts-jdk11
```

<!--more-->

docker-compose.yml

```yml
services:
  jenkins-master:
    image: "jenkins/jenkins:lts-jdk11"
    container_name: jenkins-master
    volumes:
      - "/var/jenkins_home:/var/jenkins_home"
    networks:
      - devops
    ports:
      - "8080:8080"
      - "50000:50000"
    restart: on-failure
    environment:
      JENKINS_OPTS: "--prefix=/jenkins"

networks:
  devops:
    name: devops
```

- 有证书访问，启动端口为 8083，需要将私钥和证书复制到 Jenkins image 中。

```text
FROM jenkins/jenkins:lts-jdk11

COPY --chown=jenkins:jenkins https.pem /var/lib/jenkins/cert
COPY --chown=jenkins:jenkins https.key /var/lib/jenkins/pk
ENV JENKINS_OPTS --prefix=/jenkins --httpPort=-1 --httpsPort=8083 --httpsCertificate=/var/lib/jenkins/cert --httpsPrivateKey=/var/lib/jenkins/pk
EXPOSE 8083
```

然后执行

```bash
docker run -it --name jenkins -v /var/jenkins_home:/var/jenkins_home jenkins -p 8083:8083 -p 50000:50000 --restart=on-failure jenkins/jenkins:lts-jdk11
```

### [Agent](https://hub.docker.com/r/jenkins/inbound-agent/)

```bash
docker run --init jenkins/inbound-agent -url http://jenkins-server:port -workDir=/home/jenkins/agent <secret> jenkins-agent
```

docker-compose.yml

```yml
version: "3.7"
services:
  jenkins-agent:
    image: jenkins/inbound-agent
    name: jenkins-agent
    init: true
    restart: on-failure
    environment:
      JENKINS_URL: "https://reverse-proxy/jenkins"
      JENKINS_SECRET: "62a8c05436d4dcc91a20d9cd7bc4102e63b38e0bcc12c45158149446bfa380dd"
      JENKINS_AGENT_NAME: "agent"
      JENKINS_AGENT_WORKDIR: "/home/jenkins/agent"
```

注意：`init` 选项是在 compose file 3.7 版本后引入，所以这里必须指定 `version: "3.7"` 或以上版本。
