---
title: Rsync 命令
date: 2017-07-03
modify_date: 2019-12-26
tags: Linux Utils
key: Rsync-2017-07-03
---

使用 `rsync` 作为数据同步及备份工具。

<!--more-->

## RSYNC 命令常用选项

```text
-v, --verbose               increase verbosity
-q, --quiet                 suppress non-error messages
-c, --checksum              skip based on checksum, not mod-time & size
-a, --archive               archive mode; same as -rlptgoD (no -H)
-r, --recursive             recurse into directories
-u, --update                skip files that are newer on the receiver
-n, --dry-run               show what would have been transferred
-e, --rsh=COMMAND           specify the remote shell to use
    --delete                delete extraneous files from destination dirs
    --partial               keep partially transferred files
-m, --prune-empty-dirs      prune empty directory chains from file-list
-z, --compress              compress file data during the transfer
    --exclude=PATTERN       exclude files matching PATTERN
    --exclude-from=FILE     read exclude patterns from FILE
    --include=PATTERN       don't exclude files matching PATTERN
    --include-from=FILE     read include patterns from FILE
    --stats                 give some file-transfer stats
-h, --human-readable        output numbers in a human-readable format
    --progress              show progress during transfer
-P                          same as --partial --progress
-i, --itemize-changes       output a change-summary for all updates
    --list-only             list the files instead of copying them
    --version               print version number
(-h) --help                 show this help (-h works with no other options)
```

## RSYNC 使用举例

### 同步远程目录

将远程目录 `sync@gitmaster:/repo/` 下的所有文件同步到本地 `/repo` 下，使用 `--delete` 删除目标目录中比源目录多出的文件，不同步源目录下的 `rpms/bak` 和 `src/windows` 目录，不同步 `/sync/config/exclude-list.txt` 文件中列出的文件或目录。

```zsh
rsync -avhPz --stats --delete --exclude=rpms/bak --exclude=src/windows --exclude-from=/sync/config/exclude-list.txt sync@gitmaster:/repo/ /repo
```

**注意**: 源目录如果以 `/` 结尾，表示<span style="color:red"><strong>将源目录下的所有文件</strong></span>同步到目标目录下。如果源目录不是以 `/` 结尾，表示<span style="color:red"><b>将源目录</b></span>同步到目标目录下。

### 通过跳板机同步文件 (`-e`)

```zsh
rsync -avhPz -e 'ssh -ax -J USER@PROXYHOST' REMOTEHOST:foo/bar .
rsync -avhPz -e 'ssh -o "ProxyCommand ssh -ax USER@PROXYHOST -W %h:%p"' USER@REMOTEHOST:foo/bar .
```

### 递归列出目标文件，而不是复制文件 (`-r`, `--list-only`)

```zsh
rsync -r --list-only SRC
```

### 比较两个目录或文件的不同 (`-i`)

```zsh
rsync -avhzi SRC DEST
```

### 只同步指定文件或目录 (`--include="PATTERN"`, `--exclude="PATTERN"`)

```zsh
rsync -avhPz --prune-empty-dirs --include='*/' --include='*.json' --exclude='*' SRC DEST
```

上面命令同步 SRC 目录到 DEST，按以下顺序过滤文件列表

1. 不包含空目录，
2. 包含其它所有目录
3. 包含所有匹配 `*.json` 的文件
4. 不包含任何其它文件

`rsync` 默认包含所有未匹配到的文件，上面的规则4用来阻止默认规则，可以排除其它文件。
{:.info}

## INCLUDE/EXCLUDE PATTERN RULES

规则名可以使用长名或短名，后跟空格，然后跟模式或文件名

| 长规则名 | 短规则名 | 作用                          |
| -------- | -------- | ----------------------------- |
| exclude  | -        | specifies an exclude pattern. |
| include  | +        | specifies an include pattern. |

模式中可以包含以下通配符

| 通配符 | 作用                                       |
| ------ | ------------------------------------------ |
| `*`    | 匹配任何 path component，遇到斜杠 `/` 停止 |
| `**`   | 匹配任何内容，包括斜杠                     |
| `?`    | 匹配除斜杠 `/` 以外的任何字符              |
| `[`    | 引入字符类，例如 `[a-z]` 或 `[[:alpha:]]`  |

如果模式包含 `/` （不包括结尾的 `/`）或 `**`，则它将与完整路径名匹配（算法是递归应用的，因此 **完整文件名** 实际上可以是从起始目录向下的路径的任何部分）。如果模式不包含 `/` 或 `**`，则仅与文件名的最后部分匹配。

`dir_name/***` 将匹配目录和目录中的所有内容（等于同时应用 `dir_name/` 和 `dir_name/**` 一样）。

下表是 include/exclude 的例子

| 规则 | 匹配结果 |
| -- | -- |
| `- *.o` | 排除所有与 `*.o` 匹配的名称 |
| `- /foo` | 在根目录中排除名为 `foo` 的文件或目录 |
| `- foo/` | 排除任何名为 `foo` 的目录 |
| `- /foo/*/bar` | 排除任何位于根目录中名为 `foo` 的目录下两层的名为 `bar` 的文件 |
| `- /foo/**/bar` | 排除传输根目录中名为 `foo` 的目录下两层或两层以上的名为 `bar` 的文件 |
| `+ */`, `+ *.c` 和 `- *` | 包括所有目录和C源文件，但不包含其他内容 |
| `+ foo/`, `+ foo/bar.c` 和 `-*` | 仅包括 `foo` 目录和 `foo/bar.c`（必须明确包含 `foo` 目录，否则 `*` 将排除该目录）|

对 `include/exclude` 的解释，具体请参考 `man rsync` 中的 `FILTER RULES` 一节。

> 当要传输的文件/目录列表建立后，rsync会依次检查要传输的每个文件名，根据 include/exclude 模式列表，应用最先匹配文件名的模式：如果先匹配到 exclude 模式，则不传输该文件；如果先匹配到 include 模式，则传输该文件；如果没有匹配的模式，则传输该文件。

另外，以斜杠结尾的内容是匹配目录(就像 `find -type d`)
