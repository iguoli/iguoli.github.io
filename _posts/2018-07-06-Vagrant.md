---
title: ä½¿ç”¨ Vagrant å¿«é€Ÿåˆ›å»ºè™šæ‹Ÿæœº
date: 2018-07-06
modify_date: 2021-11-05
tags: Vagrant
key: Vagrant-2018-07-06
---

## å®‰è£… [Vagrant](https://www.vagrantup.com/downloads)

##### macOS

```bash
brew install vagrant
```

##### Windows

ä»å®˜æ–¹ç½‘ç«™[ä¸‹è½½](https://www.vagrantup.com/downloads)

## å®‰è£…æ’ä»¶

### ä»£ç†æ’ä»¶ [vagrant-proxyconf](https://github.com/tmatilai/vagrant-proxyconf)

```bash
# Install
vagrant plugin install vagrant-proxyconf

# Update
vagrant plugin update vagrant-proxyconf

# Uninstall
vagrant plugin uninstall vagrant-proxyconf
```

This configuration will be written to /etc/profile.d/proxy.sh and /etc/environment on the guest.

#### é…ç½®ä»£ç†

- å…¨å±€é…ç½®ï¼Œå¯¹æ‰€æœ‰è™šæ‹Ÿæœºç”Ÿæ•ˆï¼Œåœ¨ `$HOME/.vagrant.d/Vagrantfile` æ–‡ä»¶ä¸­é…ç½®
- å•ä¸€é…ç½®ï¼Œå¯¹æŸä¸€è™šæ‹Ÿæœºç”Ÿæ•ˆï¼Œåœ¨è™šæ‹Ÿæœºç‰¹å®šçš„ Vagrantfile æ–‡ä»¶ä¸­é…ç½®

```bash
Vagrant.configure("2") do |config|
  if Vagrant.has_plugin?("vagrant-proxyconf")
    config.proxy.http     = "http://192.168.0.2:3128/"
    config.proxy.https    = "http://192.168.0.2:3128/"
    config.proxy.no_proxy = "localhost,127.0.0.1,.example.com"
  end
  # ... other stuff
end
```

ç¯å¢ƒå˜é‡ `http_proxy` å’Œ `https_proxy` å°†è¢«å†™å…¥è™šæ‹Ÿæœºç³»ç»Ÿä¸­çš„ä¸‹åˆ—æ–‡ä»¶ä¸­

- */etc/profile.d/proxy.sh*
- */etc/environment*

## åˆ›å»º Vagrantfile

```bash
vagrant init generic/centos8
```

```ruby
# -*- mode: ruby -*-
# vi: set ft=ruby :

ENV["LC_ALL"] = "en_US.UTF-8"
ENV["LANG"] = "en_US.UTF-8"

$setup = <<-'eof'
# Replace the offical yum repo with the UTSC mirror repo
sed -e 's|^baseurl=http://mirror.centos.org/$contentdir|baseurl=https://mirrors.ustc.edu.cn/centos|g' \
       -i.bak \
       /etc/yum.repos.d/CentOS-Linux-AppStream.repo \
       /etc/yum.repos.d/CentOS-Linux-BaseOS.repo \
       /etc/yum.repos.d/CentOS-Linux-Extras.repo \
       /etc/yum.repos.d/CentOS-Linux-PowerTools.repo \
       /etc/yum.repos.d/CentOS-Linux-Plus.repo

# Replace the Fedora EPEL repo with the UTSC mirror repo
sed -e 's|^metalink=|#metalink=|g' \
    -e 's|^#baseurl=https\?://download.fedoraproject.org/pub/epel/|baseurl=https://mirrors.ustc.edu.cn/epel/|g' \
    -e 's|^#baseurl=https\?://download.example/pub/epel/|baseurl=https://mirrors.ustc.edu.cn/epel/|g' \
    -i.bak \
    /etc/yum.repos.d/epel.repo
yum makecache

yum install -y git connect-proxy proxychains-ng

# Set ZSH as default shell
yum install -y zsh util-linux-user
which zsh | sudo tee -a /etc/shells
chsh -s "$(which zsh)" vagrant

# Install oh-my-zsh and plugins
su - vagrant -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
su - vagrant -c 'git clone https://github.com/zsh-users/zsh-autosuggestions ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions'
su - vagrant -c 'git clone https://github.com/zsh-users/zsh-syntax-highlighting.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting'

# Install pygments
yum install -y python3-pygments

# Install grc
git clone https://github.com/garabik/grc.git
cd grc
./install.sh
cd ..
rm -rf grc

# Customize .zshrc file
su - vagrant -c \
  'sed -e "s|^plugins=(git)|plugins=(git perl zsh-autosuggestions zsh-syntax-highlighting common-aliases z vi-mode)|" \
       -e "/^# HYPHEN_INSENSITIVE/s//HYPHEN_INSENSITIVE/" \
       -e "/^#\s\+if/,+4 {s/^#\s//}" \
       -e "/^# User configuration/a\
# Set options for GNU less\\
# --quit-if-one-screen --ignore-case --status-column\\
# --LONG-PROMPT --RAW-CONTROL-CHARS --HILITE-UNREAD\\
# --tabs=4 --no-init --window=-4\\
export LESS=\"-F -i -J -M -R -W -x4 -X -z-4\"\\
export LESSOPEN=\"|/usr/bin/pygmentize -g -O style=colorful %s\"" \
       -e "\$a\[[ -s /etc/grc.zsh ]] && source /etc/grc.zsh" \
       -i.bak \
       ~/.zshrc'
eof

Vagrant.configure("2") do |config|

  config.vm.box = "generic/centos8"
  config.vm.network "private_network", ip: "192.168.33.10"
  config.vm.hostname = "v-centos8-1"
  config.vm.define "centos8-1"
  config.vm.synced_folder "~/Downloads", "/home/vagrant/Downloads"

  config.vm.provider "virtualbox" do |vb|
    vb.name = "centos8-1"
  end

  if Vagrant.has_plugin?("vagrant-proxyconf")
    config.proxy.http      = "http://192.168.33.1:7890/"
    config.proxy.https     = "http://192.168.33.1:7890/"
    config.proxy.no_proxy  = "localhost,127.0.0.1,.example.com"
    config.yum_proxy.http  = "DIRECT"
  end

  # config.vm.provision "shell", inline: $setup
    config.vm.provision "shell", path: 'https://raw.githubusercontent.com/iguoli/provision/main/vagrant-provision.sh'
end
```

<!--more-->

## Vagrant å¸¸ç”¨å‘½ä»¤

### åˆ—å‡ºæ‰€æœ‰ Vagrant è™šæ‹ŸæœºçŠ¶æ€

```bash
vagrant global-status
```

```text
id       name      provider   state   directory
--------------------------------------------------------------------------
5beb3f1  centos8-1 virtualbox running /Vagrant/centos8-1
b70aca5  centos8-2 virtualbox running /Vagrant/centos8-2
```

### åˆ é™¤è™šæ‹Ÿæœº

```bash
vagrant destroy 5beb3f1
```


### SSH åˆ°è™šæ‹Ÿæœº

```bash
vagrant ssh 5beb3f1
```

## Network

### VirtualBox network

<style>
    .network-table td:nth-child(1) { font-weight: bold; background-color: whitesmoke}
    .network-table tr:nth-child(1) td:nth-child(n+2):nth-child(-n+6) { background: red; }
    .network-table tr:nth-child(2) td:nth-child(2) { background: red; }
    .network-table tr:nth-child(2) td:nth-child(3) { background: palegreen; }
    .network-table tr:nth-child(2) td:nth-child(4) { background: orange; }
    .network-table tr:nth-child(2) td:nth-child(5) { background: palegreen; }
    .network-table tr:nth-child(2) td:nth-child(6) { background: orange; }
    .network-table tr:nth-child(3) td:nth-child(n+2):nth-child(-n+3) { background: palegreen; }
    .network-table tr:nth-child(3) td:nth-child(4) { background: orange; }
    .network-table tr:nth-child(3) td:nth-child(5) { background: palegreen; }
    .network-table tr:nth-child(3) td:nth-child(6) { background: orange; }
    .network-table tr:nth-child(4) td:nth-child(n+2):nth-child(-n+6) { background: palegreen; }
    .network-table tr:nth-child(5) td:nth-child(2) { background: palegreen; }
    .network-table tr:nth-child(5) td:nth-child(n+3):nth-child(-n+6) { background: red; }
    .network-table tr:nth-child(6) td:nth-child(n+2):nth-child(-n+4) { background: palegreen; }
    .network-table tr:nth-child(6) td:nth-child(5) { background: red; }
    .network-table tr:nth-child(6) td:nth-child(6) { background: palegreen; }

    .nat-hostonly-table td:nth-child(1) { font-weight: bold; background-color: whitesmoke}
    .nat-hostonly-table tr:nth-child(1) td:nth-child(n+2):nth-child(-n+5) { background: palegreen; }
    .nat-hostonly-table tr:nth-child(1) td:last-child { background: orange; }
</style>

|                  | VM â†” VM | VM â†’ Host |  VM â† Host   | VM â†’ LAN |   VM â† LAN   |
| ---------------- | :-----: | :--------: | :----------: | :------: | :----------: |
| Not attached     |    âœ•    |     âœ•      |      âœ•       |    âœ•     |      âœ•       |
| NAT              |    âœ•    |     âœ“      | Port Forward |    âœ“     | Port Forward |
| NAT Network      |    âœ“    |     âœ“      | Port Forward |    âœ“     | Port Forward |
| Bridged          |    âœ“    |     âœ“      |      âœ“       |    âœ“     |      âœ“       |
| Internal Network |    âœ“    |     âœ•      |      âœ•       |    âœ•     |      âœ•       |
| Host-only        |    âœ“    |     âœ“      |      âœ“       |    âœ•     |      âœ•       |
{:.network-table}

### Vagrant network

Vagrant ä¸ VirtualBox çš„ç½‘ç»œå¯¹åº”å¦‚ä¸‹

| Vagrant network | VirtualBox network |
| :-------------: | :----------------: |
| forwarded_port  |        NAT         |
| private_network |     Host-only      |
| public_network  |      Bridged       |

##### æ³¨æ„: NAT ç½‘ç»œå°†è¢«éšå«åœ°åˆ›å»º

å¦‚æœé…ç½®æ–‡ä»¶åªæœ‰ä¸€ä¸ª `private_network`ï¼ŒVagrant ä¼šåˆ›å»ºä¸€ä¸ª NAT ç½‘ç»œå’Œä¸€ä¸ª Host-only ç½‘ç»œ

```ruby
# Create a NAT and a Host-only network in VirtualBox
config.vm.network "private_network", ip: "192.168.33.10"
```

|                   | VM â†” VM | VM â†’ Host | VM â† Host | VM â†’ LAN |   VM â† LAN  |
| ----------------- | :-----: | :--------: | :-------: | :------: | :----------: |
| NAT and Host-only |    âœ“    |     âœ“      |     âœ“     |    âœ“     | Port Forward |
{:.nat-hostonly-table}

å¦‚æœé…ç½®æ–‡ä»¶æœ‰ä¸¤ä¸ªä»¥ä¸Šçš„ `private_network`ï¼ŒVagrant ä¸å†è‡ªåŠ¨åˆ›å»º NAT ç½‘ç»œï¼Œåªæœ‰å¤šä¸ª Host-only ç½‘ç»œ

```ruby
# Create two Host-only networks in VirtualBox
config.vm.network "private_network", ip: "192.168.9.10"
config.vm.network "private_network", ip: "192.168.33.10"
```

## å‚è€ƒæ–‡æ¡£

- [VirtualBox Network Settings: Complete Guide](https://www.nakivo.com/blog/virtualbox-network-setting-guide/)
- [Vagrant ç½‘ç»œé…ç½®](https://juejin.cn/post/6844903783705608205)
- [Vagrant provider networking](https://www.vagrantup.com/docs/providers/virtualbox/networking)